{% extends "admin_base.html" %}
{% block title %}Objedn√°vky a licence ‚Äì DokuCheck Admin{% endblock %}
{% block content %}
<h2 style="font-size:1.2em;font-weight:600;margin-bottom:8px;">Spr√°va objedn√°vek</h2>
<p style="margin-bottom:20px;color:#6b7280;">Nov√© objedn√°vky ‚Üí vygenerovat fakturu (ulo≈æ√≠ se na server) ‚Üí ƒçekaj√≠c√≠ na platbu ‚Üí st√°hnout fakturu / odeslat z√°kazn√≠kovi manu√°lnƒõ ‚Üí potvrdit platbu.</p>

{# A) Nov√© objedn√°vky (NEW_ORDER) ‚Äì OBJEDNAT (vygeneruje fakturu + notifikace) #}
<h3 style="font-size:1.05em;margin-bottom:10px;color:#1f2937;">A) {{ env_labels.label_section_new_orders|default('Nov√© objedn√°vky') }}</h3>
<div class="table-container">
    <table class="table-dense">
        <thead>
            <tr>
                <th>ƒå. objedn√°vky</th>
                <th>Datum</th>
                <th>Jm√©no / Firma</th>
                <th>Iƒå</th>
                <th>E-mail</th>
                <th>Tarif</th>
                <th>Cena</th>
                <th>Sleva</th>
                <th>Stav</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            {% for o in orders_new %}
            <tr>
                <td>{{ o.order_display_number or o.id }}</td>
                <td>{{ (o.created_at or '')[:16] }}</td>
                <td>{{ o.jmeno_firma or '‚Äî' }}{% if o.ulice or o.mesto %}<br><small style="color:#9ca3af;">{{ o.ulice or '' }} {{ o.mesto or '' }} {{ o.psc or '' }}</small>{% endif %}</td>
                <td>{{ o.ico or '‚Äî' }}{% if o.dic %}<br><small>DIƒå: {{ o.dic }}</small>{% endif %}</td>
                <td>{{ o.email or '‚Äî' }}</td>
                <td>{{ (o.tarif or '‚Äî')|upper }}</td>
                <td>{{ o.amount_czk_final or o.amount_czk or '‚Äî' }} Kƒç</td>
                <td>
                    {% if o.discount_applied %}<span style="background:#d1fae5;color:#047857;padding:2px 6px;border-radius:4px;font-size:0.8em;">-{{ o.discount_percent|int }}%</span>
                    {% elif o.discount_requested %}<span style="background:#fef3c7;color:#b45309;padding:2px 6px;border-radius:4px;font-size:0.8em;">≈Ω√°dost</span>
                    {% else %}‚Äî{% endif %}
                </td>
                <td><span style="background:#dbeafe;color:#1d4ed8;padding:4px 8px;border-radius:4px;font-size:0.85em;">{{ env_labels.label_status_new|default('Nov√°') }}</span></td>
                <td style="white-space:nowrap;">
                    <a href="{{ url_for('admin.download_invoice', order_id=o.id) }}" class="btn btn-outline-secondary btn-sm">ST√ÅHNOUT FAKTURU (PDF)</a>
                    {% if o.discount_requested and not o.discount_applied %}
                    <form method="post" action="{{ url_for('admin.apply_discount') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-sm" style="background:#059669;color:#fff;" onclick="return confirm('Uplatnit slevu 20% na objedn√°vku #{{ o.order_display_number or o.id }}?');">UPLATNIT SLEVU</button>
                    </form>
                    {% endif %}
                    <form method="post" action="{{ url_for('admin.generate_invoice') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-primary btn-sm">{{ env_labels.label_btn_obednat|default('OBJEDNAT') }}</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.regenerate_invoice') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">GENEROVAT ZNOVU</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.confirm_payment') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">{{ env_labels.label_btn_activate|default('VYTVO≈òIT U≈ΩIVATELE A AKTIVOVAT') }}</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_pending_order') }}" style="display:inline;margin-left:6px;" onsubmit="return confirm('Opravdu smazat objedn√°vku #{{ o.order_display_number or o.id }}?');">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm">SMAZAT</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="10" class="text-center text-muted" style="padding:24px;">≈Ω√°dn√© nov√© objedn√°vky.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# B) ƒåekaj√≠c√≠ na platbu (WAITING_PAYMENT) ‚Äì toggle ƒåSOB + POTVRDIT P≈òIJET√ç PLATBY #}
<h3 style="font-size:1.05em;margin:24px 0 10px;color:#1f2937;">B) {{ env_labels.label_section_waiting_payment|default('ƒåekaj√≠c√≠ na platbu') }}</h3>
<div style="margin-bottom:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
    <form method="post" action="{{ url_for('admin.toggle_auto_activate_csob') }}" id="form-csob" style="display:flex;align-items:center;gap:8px;">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" name="auto_activate_csob" value="1" {% if auto_activate_csob %}checked{% endif %} onchange="document.getElementById('form-csob').submit();">
            <span style="font-size:0.9em;">Automaticky aktivovat po zaplacen√≠ (ƒåSOB)</span>
        </label>
    </form>
    <script>
    document.getElementById('form-csob').addEventListener('submit', function(e) {
        var cb = this.querySelector('input[name=auto_activate_csob]');
        if (!cb.checked) { var h = document.createElement('input'); h.type = 'hidden'; h.name = 'auto_activate_csob'; h.value = '0'; this.appendChild(h); }
    });
    </script>
    <span style="font-size:0.85em;color:#6b7280;">Manu√°lnƒõ: tlaƒç√≠tko ‚ÄûPOTVRDIT P≈òIJET√ç PLATBY‚Äú n√≠≈æe.</span>
</div>
<div class="table-container">
    <table class="table-dense">
        <thead>
            <tr>
                <th>ƒå. objedn√°vky</th>
                <th>Datum</th>
                <th>Jm√©no / Firma</th>
                <th>E-mail</th>
                <th>Tarif</th>
                <th>Stav</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            {% for o in orders_waiting %}
            <tr>
                <td>{{ o.order_display_number or o.id }}</td>
                <td>{{ (o.created_at or '')[:16] }}</td>
                <td>{{ o.jmeno_firma or '‚Äî' }}</td>
                <td>{{ o.email or '‚Äî' }}</td>
                <td>{{ (o.tarif or '‚Äî')|upper }}</td>
                <td><span style="background:#fef3c7;color:#b45309;padding:4px 8px;border-radius:4px;font-size:0.85em;">{{ env_labels.label_status_waiting_payment|default('ƒåek√° na platbu') }}</span></td>
                <td style="white-space:nowrap;">
                    <a href="{{ url_for('admin.download_invoice', order_id=o.id) }}" class="btn btn-outline-secondary btn-sm">ST√ÅHNOUT FAKTURU (PDF)</a>
                    <form method="post" action="{{ url_for('admin.regenerate_invoice') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">GENEROVAT ZNOVU</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.confirm_payment') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-primary btn-sm">{{ env_labels.label_btn_confirm_payment|default('POTVRDIT PLATBU') }}</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.confirm_payment') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">{{ env_labels.label_btn_activate|default('VYTVO≈òIT U≈ΩIVATELE A AKTIVOVAT') }}</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.activate_without_invoice') }}" style="display:inline;margin-left:6px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">{{ env_labels.label_btn_activate_without_invoice|default('AKTIVOVAT BEZ FAKTURY') }}</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_user_from_order') }}" style="display:inline;margin-left:6px;" onsubmit="return confirm('Opravdu SMAZAT U≈ΩIVATELE (licenci) pro e-mail {{ o.email }}? Objedn√°vka z≈Østane.');">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Sma≈æe u≈æivatele (licenci) z datab√°ze. Objedn√°vka z≈Østane.">üóëÔ∏è SMAZAT U≈ΩIVATELE</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_pending_order') }}" style="display:inline;margin-left:6px;" onsubmit="return confirm('Opravdu smazat objedn√°vku #{{ o.order_display_number or o.id }}?');">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm">SMAZAT OBJ.</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center text-muted" style="padding:24px;">≈Ω√°dn√© objedn√°vky ƒçekaj√≠c√≠ na platbu.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# C) Aktivn√≠ licence (Zaplaceno) #}
<h3 style="font-size:1.05em;margin:24px 0 10px;color:#1f2937;">C) {{ env_labels.label_section_active_licenses|default('Aktivn√≠ licence (Zaplaceno)') }}</h3>
<p style="margin-bottom:10px;color:#6b7280;font-size:0.9em;">U≈æivatel√© s p≈ô√≠stupem (Basic / PRO).</p>
<div class="table-container">
    <table class="table-dense">
        <thead>
            <tr>
                <th>E-mail</th>
                <th>Jm√©no</th>
                <th>Tarif</th>
                <th>Expirace</th>
            </tr>
        </thead>
        <tbody>
            {% for l in active_licenses %}
            <tr>
                <td>{{ l.email or '‚Äî' }}</td>
                <td>{{ l.user_name or '‚Äî' }}</td>
                <td><span style="background:#d1fae5;color:#047857;padding:4px 8px;border-radius:4px;font-size:0.85em;">{{ l.tier_name or 'Pro' }}</span></td>
                <td>{{ (l.license_expires or '')[:10] if l.license_expires else '‚Äî' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="text-center text-muted" style="padding:24px;">≈Ω√°dn√© aktivn√≠ licence (nebo pouze Trial/Free).</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
