{% extends "admin_base.html" %}
{% block title %}PDF DokuCheck Admin – Tier definice{% endblock %}
{% block content %}
<h2 style="font-size:1.2em;font-weight:600;margin-bottom:8px;">Globální definice tierů</h2>
<p class="text-muted small mb-3">Úpravy se projeví u všech uživatelů s daným tierem. U uživatele v Nástěnce měníte pouze výběr tieru (dropdown).</p>
<div class="table-container">
    <table class="table-dense">
        <thead>
            <tr>
                <th>Název</th>
                <th>Max souborů</th>
                <th>Max zařízení</th>
                <th>Podpisy</th>
                <th>Čas. razítka</th>
                <th>Excel export</th>
                <th>Pokročilé filtry</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            {% for t in tiers_list %}
            <tr data-tier-id="{{ t.id }}" data-name="{{ t.name|e }}" data-max-files="{{ t.max_files_limit }}" data-max-devices="{{ t.max_devices }}" data-allow-sig="{{ 1 if t.allow_signatures else 0 }}" data-allow-ts="{{ 1 if t.allow_timestamp else 0 }}" data-allow-excel="{{ 1 if t.allow_excel_export else 0 }}" data-allow-filters="{{ 1 if (t.allow_advanced_filters|default(0)) else 0 }}">
                <td><span class="badge badge-{{ t.name|lower }}">{{ t.name }}</span></td>
                <td>{{ t.max_files_limit }}</td>
                <td>{{ t.max_devices }}</td>
                <td>{{ 'Ano' if t.allow_signatures else 'Ne' }}</td>
                <td>{{ 'Ano' if t.allow_timestamp else 'Ne' }}</td>
                <td>{{ 'Ano' if t.allow_excel_export else 'Ne' }}</td>
                <td>{{ 'Ano' if (t.allow_advanced_filters|default(0)) else 'Ne' }}</td>
                <td><button type="button" class="action-btn primary-btn btn-edit-tier">Upravit</button></td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted" style="padding:24px;">Spusťte migraci: <code>python migrate_tiers.py</code></td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="tierEditModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Upravit tier</h3>
            <button class="modal-close" onclick="document.getElementById('tierEditModal').classList.remove('active')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit_tier_id">
            <div class="form-group">
                <label class="small">Název</label>
                <input type="text" id="edit_tier_name" class="form-control">
            </div>
            <div class="form-group">
                <label class="small">Max souborů (dávka)</label>
                <input type="number" id="edit_max_files" class="form-control" min="1">
            </div>
            <div class="form-group">
                <label class="small">Max zařízení</label>
                <input type="number" id="edit_max_devices" class="form-control" min="1">
            </div>
            <div class="form-check">
                <input type="checkbox" id="edit_allow_sig" class="form-control" style="width:auto;">
                <label class="small" for="edit_allow_sig">Podpisy</label>
            </div>
            <div class="form-check">
                <input type="checkbox" id="edit_allow_ts" class="form-control" style="width:auto;">
                <label class="small" for="edit_allow_ts">Časová razítka</label>
            </div>
            <div class="form-check">
                <input type="checkbox" id="edit_allow_excel" class="form-control" style="width:auto;">
                <label class="small" for="edit_allow_excel">Excel export</label>
            </div>
            <div class="form-check">
                <input type="checkbox" id="edit_allow_filters" class="form-control" style="width:auto;">
                <label class="small" for="edit_allow_filters">Pokročilé filtry (sloupce, PDF/A, podpis, razítko)</label>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('tierEditModal').classList.remove('active')">Zrušit</button>
            <button type="button" class="btn btn-primary" id="btnTierSave">Uložit</button>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.querySelectorAll('.btn-edit-tier').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var tr = this.closest('tr');
        document.getElementById('edit_tier_id').value = tr.getAttribute('data-tier-id');
        document.getElementById('edit_tier_name').value = tr.getAttribute('data-name') || '';
        document.getElementById('edit_max_files').value = tr.getAttribute('data-max-files') || '';
        document.getElementById('edit_max_devices').value = tr.getAttribute('data-max-devices') || '';
        document.getElementById('edit_allow_sig').checked = tr.getAttribute('data-allow-sig') === '1';
        document.getElementById('edit_allow_ts').checked = tr.getAttribute('data-allow-ts') === '1';
        document.getElementById('edit_allow_excel').checked = tr.getAttribute('data-allow-excel') === '1';
        document.getElementById('edit_allow_filters').checked = tr.getAttribute('data-allow-filters') === '1';
        document.getElementById('tierEditModal').classList.add('active');
    });
});
document.getElementById('btnTierSave').onclick = function() {
    var fd = new FormData();
    fd.append('tier_id', document.getElementById('edit_tier_id').value);
    fd.append('name', document.getElementById('edit_tier_name').value);
    fd.append('max_files_limit', document.getElementById('edit_max_files').value);
    fd.append('max_devices', document.getElementById('edit_max_devices').value);
    fd.append('allow_signatures', document.getElementById('edit_allow_sig').checked ? '1' : '0');
    fd.append('allow_timestamp', document.getElementById('edit_allow_ts').checked ? '1' : '0');
    fd.append('allow_excel_export', document.getElementById('edit_allow_excel').checked ? '1' : '0');
    fd.append('allow_advanced_filters', document.getElementById('edit_allow_filters').checked ? '1' : '0');
    var url = '{{ url_for("admin.api_update_tier") }}';
    fetch(url, { method: 'POST', body: fd })
        .then(function(r) {
            if (!r.ok) return r.text().then(function(t) { throw new Error(r.status + ': ' + (t && t.slice(0, 200))); });
            return r.json();
        })
        .then(function(d) {
            if (d.success) { document.getElementById('tierEditModal').classList.remove('active'); location.reload(); }
            else { alert(d.error || 'Chyba'); }
        })
        .catch(function(err) {
            alert('Chyba při ukládání: ' + err.message);
        });
};
document.getElementById('tierEditModal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
});
</script>
{% endblock %}
