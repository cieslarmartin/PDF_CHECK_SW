{% extends "admin_base.html" %}
{% block title %}DokuCheck Admin – Trial správa{% endblock %}
{% block content %}
<h2 style="font-size:1.2em;font-weight:600;margin-bottom:16px;">Trial správa</h2>

{# Souhrnné statistiky #}
<div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:24px;">
    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:12px 20px;min-width:160px;">
        <div style="font-size:0.75em;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">Web Trial (IP)</div>
        <div style="font-size:1.5em;font-weight:700;color:#047857;">{{ web_trial_list|length }}</div>
        <div style="font-size:0.8em;color:#6b7280;">unikátních IP adres</div>
    </div>
    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 20px;min-width:160px;">
        <div style="font-size:0.75em;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">Desktop Agent Trial</div>
        <div style="font-size:1.5em;font-weight:700;color:#1d4ed8;">{{ trial_list|length }}</div>
        <div style="font-size:0.8em;color:#6b7280;">unikátních zařízení</div>
    </div>
    <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:12px 20px;min-width:160px;">
        <div style="font-size:0.75em;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">Celkem kontrol (web)</div>
        <div style="font-size:1.5em;font-weight:700;color:#b45309;">{{ web_trial_list|sum(attribute='total_batches') }}</div>
        <div style="font-size:0.8em;color:#6b7280;">dávek / pokusů</div>
    </div>
</div>

{# A) Web Trial (online check bez přihlášení – podle IP) #}
<h3 style="font-size:1.05em;margin-bottom:10px;color:#1f2937;">A) Web Trial – online kontroly (podle IP)</h3>
<p class="text-muted small mb-2">Každý řádek = unikátní IP adresa, která vyzkoušela online kontrolu bez přihlášení. Limit: 3 dávky / 24 h na IP.</p>
<div class="table-container">
    <table class="table-dense">
        <thead>
            <tr>
                <th>IP adresa</th>
                <th>Počet kontrol (dávek)</th>
                <th>Poslední aktivita</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            {% for row in web_trial_list %}
            <tr>
                <td style="font-family:monospace;font-size:0.85em;">{{ row.ip_address }}</td>
                <td>{{ row.total_batches }}</td>
                <td>{{ (row.last_used or '—')[:19] }}</td>
                <td>
                    <form action="{{ url_for('admin.api_web_trial_reset') }}" method="post" style="display:inline;" onsubmit="return confirm('Resetovat limit pro IP {{ row.ip_address }}?');">
                        <input type="hidden" name="ip_address" value="{{ row.ip_address }}">
                        <button type="submit" class="action-btn" style="background:#fef3c7;border-color:#f59e0b;">Resetovat limit</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="text-center text-muted" style="padding:24px;">Žádná Web Trial aktivita</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# B) Desktop Agent Trial (podle Machine-ID) #}
<h3 style="font-size:1.05em;margin:24px 0 10px;color:#1f2937;">B) Desktop Agent Trial (podle Machine-ID)</h3>
<p class="text-muted small mb-2">Zkušební režim Desktop Agenta je vázaný na zařízení (X-Machine-ID). Celkový limit: 10 souborů na zařízení.</p>
<div class="table-container">
    <table class="table-dense">
        <thead>
            <tr>
                <th>Machine-ID</th>
                <th>Celkem zkontrolovaných souborů</th>
                <th>Poslední aktivita</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            {% for row in trial_list %}
            <tr>
                <td style="font-family:monospace;font-size:0.8em;max-width:280px;overflow:hidden;text-overflow:ellipsis;" title="{{ row.machine_id }}">{{ row.machine_id }}</td>
                <td>{{ row.total_files }}</td>
                <td>{{ row.last_seen or '—' }}</td>
                <td>
                    <form action="{{ url_for('admin.api_trial_reset') }}" method="post" style="display:inline;" onsubmit="return confirm('Vynulovat Trial pro toto zařízení?');">
                        <input type="hidden" name="machine_id" value="{{ row.machine_id }}">
                        <button type="submit" class="action-btn" style="background:#fef3c7;border-color:#f59e0b;">Resetovat Trial</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="text-center text-muted" style="padding:24px;">Žádná Desktop Agent Trial aktivita</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
