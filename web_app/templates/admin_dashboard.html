{% extends "admin_base.html" %}
{% block title %}DokuCheck – Přehled{% endblock %}
{% block header_right %}
<button type="button" class="btn btn-secondary btn-small" id="btn-git-pull" onclick="doGitPull()" title="Stáhnout z GitHubu">&#128260; Git Pull</button>
{% endblock %}
{% block content %}

{# ============ KPI DLAŽDICE ============ #}
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-bottom:24px;">
    <div class="admin-card" style="padding:16px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;">
        <div style="font-size:0.85em;color:#0369a1;">Celkem kontrol dnes</div>
        <div style="font-size:1.5em;font-weight:700;">{{ activity_stats.checks_today|default(0) }}</div>
    </div>
    <div class="admin-card" style="padding:16px;background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;">
        <div style="font-size:0.85em;color:#b45309;">Trial batche dnes</div>
        <div style="font-size:1.5em;font-weight:700;">{{ activity_stats.trial_batches_today|default(0) }}</div>
    </div>
    <div class="admin-card" style="padding:16px;background:#d1fae5;border:1px solid #6ee7b7;border-radius:8px;">
        <div style="font-size:0.85em;color:#047857;">Aktivní licence</div>
        <div style="font-size:1.5em;font-weight:700;">{{ activity_stats.active_licenses|default(0) }}</div>
    </div>
    <div class="admin-card" style="padding:16px;background:#fce7f3;border:1px solid #f9a8d4;border-radius:8px;">
        <div style="font-size:0.85em;color:#9d174d;">Čeká na platbu</div>
        <div style="font-size:1.5em;font-weight:700;">{{ activity_stats.pending_orders|default(0) }}</div>
    </div>
</div>

{# ============ GRAFY ============ #}
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
    <div class="chart-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
        <h3 style="font-size:0.95em;margin:0 0 12px;color:#374151;">Aktivita – soubory za den (30 dní)</h3>
        <div style="height:220px;"><canvas id="chartActivity30"></canvas></div>
    </div>
    <div class="chart-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
        <h3 style="font-size:0.95em;margin:0 0 12px;color:#374151;">Rozložení tarifů (počet licencí)</h3>
        <div style="height:220px;"><canvas id="chartTiersPie"></canvas></div>
    </div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
    <div class="chart-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
        <h3 style="font-size:0.95em;margin:0 0 12px;color:#374151;">Kontroly – úspěšné vs. chybné</h3>
        <div style="height:220px;"><canvas id="chartChecksBar"></canvas></div>
    </div>
    <div class="chart-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
        <h3 style="font-size:0.95em;margin:0 0 12px;color:#374151;">KPI – přehled</h3>
        <table class="table-dense" style="width:100%;">
            <tbody>
                <tr><td>Aktivní licence</td><td><strong>{{ (kpis or {}).get('active_licenses', 0) }}</strong></td></tr>
                <tr><td>Free / Trial</td><td>{{ (kpis or {}).get('free_licenses', 0) }}</td></tr>
                <tr><td>Placené</td><td>{{ (kpis or {}).get('paid_licenses', 0) }}</td></tr>
                <tr><td>Celkem kontrol (souborů)</td><td><strong>{{ (kpis or {}).get('total_checks', 0) }}</strong></td></tr>
                <tr><td>Úspěšné</td><td style="color:#16a34a;">{{ (kpis or {}).get('success_checks', 0) }}</td></tr>
                <tr><td>Chybné</td><td style="color:#dc2626;">{{ (kpis or {}).get('error_checks', 0) }}</td></tr>
                <tr><td>Chybovost</td><td>{{ (kpis or {}).get('error_rate_percent', 0) }} %</td></tr>
            </tbody>
        </table>
    </div>
</div>

{# ============ ŽEBŘÍČEK + POSLEDNÍ AKTIVITA ============ #}
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
    <div class="chart-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
        <h3 style="font-size:0.95em;margin:0 0 12px;color:#374151;">Žebříček uživatelů (30 dní)</h3>
        <table class="table-dense" style="width:100%;">
            <thead><tr><th>#</th><th>Uživatel</th><th>Souborů</th></tr></thead>
            <tbody>
                {% for r in user_ranking %}
                <tr><td>{{ loop.index }}</td><td>{{ r.email or r.user_name or (r.user_id or '')[:20] }}</td><td><strong>{{ r.total_files }}</strong></td></tr>
                {% else %}
                <tr><td colspan="3" class="text-center text-muted" style="padding:12px;">Zatím žádná aktivita.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="chart-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
        <h3 style="font-size:0.95em;margin:0 0 12px;color:#374151;">Poslední aktivita</h3>
        <table class="table-dense" style="width:100%;">
            <thead><tr><th>IP</th><th>Čas</th><th>Typ</th><th>Souborů</th></tr></thead>
            <tbody>
                {% for row in activity_log[:10] %}
                <tr>
                    <td><small style="font-family:monospace;">{{ row.ip_address or '—' }}</small></td>
                    <td><small>{{ (row.timestamp or '—')[:16] }}</small></td>
                    <td>{% if row.source_type == 'web_trial' %}Trial{% elif row.source_type == 'agent' %}Agent{% else %}{{ row.source_type or '—' }}{% endif %}</td>
                    <td>{{ row.file_count }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center text-muted" style="padding:12px;">Zatím žádné záznamy.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# ============ ODKAZY NA WEB (sbalitelné) ============ #}
<details style="margin-bottom:24px;">
    <summary style="cursor:pointer;font-size:1em;font-weight:600;color:#374151;padding:8px 0;">Odkazy na web</summary>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:12px;">
        <div class="table-container" style="margin:0;">
            <h3 style="font-size:0.95em;padding:12px 16px;margin:0;background:#f0f9ff;border-bottom:1px solid #e5e7eb;">Agent</h3>
            <table class="table-dense">
                <tbody>
                    <tr><td style="padding:8px 16px;"><strong>API konfigurace</strong></td><td style="padding:8px 16px;"><a href="{{ url_for('agent_config', _external=True) }}" target="_blank">/api/agent-config</a></td></tr>
                    <tr><td style="padding:8px 16px;">VOP</td><td style="padding:8px 16px;"><a href="{{ url_for('vop', _external=True) }}" target="_blank">{{ url_for('vop', _external=True) }}</a></td></tr>
                    <tr><td style="padding:8px 16px;">GDPR</td><td style="padding:8px 16px;"><a href="{{ url_for('gdpr', _external=True) }}" target="_blank">{{ url_for('gdpr', _external=True) }}</a></td></tr>
                </tbody>
            </table>
        </div>
        <div class="table-container" style="margin:0;">
            <h3 style="font-size:0.95em;padding:12px 16px;margin:0;background:#f9fafb;border-bottom:1px solid #e5e7eb;">Web</h3>
            <table class="table-dense">
                <tbody>
                    <tr><td style="padding:8px 16px;">Landing</td><td style="padding:8px 16px;"><a href="{{ url_for('index', _external=True) }}" target="_blank">{{ url_for('index', _external=True) }}</a></td></tr>
                    <tr><td style="padding:8px 16px;">Aplikace</td><td style="padding:8px 16px;"><a href="{{ url_for('app_main', _external=True) }}" target="_blank">/app</a></td></tr>
                    <tr><td style="padding:8px 16px;">Portál</td><td style="padding:8px 16px;"><a href="{{ url_for('portal', _external=True) }}" target="_blank">{{ url_for('portal', _external=True) }}</a></td></tr>
                    <tr><td style="padding:8px 16px;">Checkout</td><td style="padding:8px 16px;"><a href="{{ url_for('checkout', _external=True) }}" target="_blank">{{ url_for('checkout', _external=True) }}</a></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</details>

{# ============ UŽIVATELÉ (tabulka) ============ #}
<div id="users" style="margin-bottom:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:12px;">
        <h2 style="font-size:1.1em;margin:0;">Uživatelé a licence</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <form method="get" action="{{ url_for('admin.dashboard') }}" style="display:flex;gap:6px;align-items:center;">
                <input type="hidden" name="tier" value="{{ tier_filter }}">
                <input type="hidden" name="status" value="{{ status_filter }}">
                <input type="text" name="q" class="form-control" style="width:160px;" placeholder="Vyhledat…" value="{{ search }}">
                <button type="submit" class="btn btn-sm btn-secondary">Hledat</button>
            </form>
            <form method="get" action="{{ url_for('admin.dashboard') }}" style="display:flex;gap:6px;align-items:center;">
                <input type="hidden" name="q" value="{{ search }}">
                <input type="hidden" name="status" value="{{ status_filter }}">
                <select name="tier" class="form-control form-select" style="width:120px;" onchange="this.form.submit()">
                    <option value="">Všechny tarify</option>
                    {% for t in tiers_list %}
                    <option value="{{ t.name }}" {{ 'selected' if tier_filter == t.name else '' }}>{{ t.name }}</option>
                    {% endfor %}
                </select>
            </form>
            <form method="get" action="{{ url_for('admin.dashboard') }}" style="display:flex;gap:6px;align-items:center;">
                <input type="hidden" name="q" value="{{ search }}">
                <input type="hidden" name="tier" value="{{ tier_filter }}">
                <select name="status" class="form-control form-select" style="width:110px;" onchange="this.form.submit()">
                    <option value="">Stav účtu</option>
                    <option value="active" {{ 'selected' if status_filter == 'active' else '' }}>Aktivní</option>
                    <option value="blocked" {{ 'selected' if status_filter == 'blocked' else '' }}>Blokovaný</option>
                </select>
            </form>
            <button class="btn btn-primary btn-sm" onclick="openCreateModal()">+ Nová licence</button>
        </div>
    </div>
    <div class="table-container">
        <table class="table-dense">
            <thead>
                <tr>
                    <th>E-mail / Jméno</th>
                    <th>Tarif</th>
                    <th>Zařízení</th>
                    <th>Poslední aktivita</th>
                    <th>Poslední IP</th>
                    <th>Soubory</th>
                    <th>Platba</th>
                    <th>Heslo</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody>
                {% for license in licenses %}
                <tr data-api-key="{{ license.api_key }}" data-tier-id="{{ license.tier_id or '' }}" data-email="{{ (license.email or '')|e }}" data-user-name="{{ (license.user_name or '')|e }}" data-license-expires="{{ license.license_expires or '' }}" data-is-active="{{ 1 if license.is_active else 0 }}" data-payment-method="{{ (license.payment_method or '')|e }}" data-last-payment-date="{{ license.last_payment_date or '' }}" data-password-plain="{{ (license.get('password_plain_stored') or '')|e }}">
                    <td>
                        <strong>{{ license.email or '—' }}</strong>
                        {% if license.user_name and license.user_name != license.email %}<br><small style="color:#6b7280;">{{ license.user_name }}</small>{% endif %}
                    </td>
                    <td><span class="badge badge-{{ license.tier_name|lower }}">{{ license.tier_name }}</span></td>
                    <td title="{% if license.device_names %}Stanice: {{ license.device_names|e }}{% else %}Počet aktivních zařízení{% endif %}">{{ license.active_devices }}/{{ license.max_devices if license.max_devices and license.max_devices != -1 else '∞' }}{% if license.device_names %} <small style="color:#6b7280;" title="Stanice: {{ license.device_names|e }}">({{ license.device_names|truncate(30, True) }})</small>{% endif %}</td>
                    <td><small>{% if license.last_active %}{{ license.last_active[:16] }}{% else %}—{% endif %}</small></td>
                    <td><small style="font-family:monospace;font-size:0.85em;">{{ license.last_ip or '—' }}</small></td>
                    <td>{{ license.total_checks }}</td>
                    <td><small>{{ license.payment_method or '—' }}<br>{{ (license.last_payment_date or '—')[:10] }}</small></td>
                    <td><small style="font-family:monospace;font-size:0.85em;">{{ (license.get('password_plain_stored') or '—')|e }}</small></td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn primary-btn" onclick="openEditModalFromRow(this.closest('tr'))" title="Upravit">Upravit</button>
                            <button class="action-btn" onclick="toggleLicense('{{ license.api_key }}', {{ 'false' if license.is_active else 'true' }})">{{ 'DEAKTIVOVAT' if license.is_active else 'AKTIVOVAT' }}</button>
                            <button class="action-btn danger" onclick="deleteLicense('{{ license.api_key }}')">SMAZAT</button>
                            <button class="action-btn primary-btn" data-api-key="{{ license.api_key }}" onclick="openWelcomePackageModal(this)">INFO</button>
                            <a href="{{ url_for('admin.user_audit') }}?user={{ license.api_key }}" class="action-btn">Audit</a>
                            <button class="action-btn" data-api-key="{{ license.api_key }}" data-user-display="{{ (license.user_name or license.email or license.api_key)|e }}" data-password-plain="{{ (license.get('password_plain_stored') or '')|e }}" onclick="openChangePasswordModal(this)">Heslo</button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="9" class="text-center text-muted" style="padding:24px;">Žádné licence. Klikněte na „Nová licence".</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# ============ MODÁLY ============ #}
<div class="modal-overlay" id="createModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Vytvořit novou licenci</h3>
            <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
        </div>
        <form id="createForm" onsubmit="submitCreateForm(event)">
            <div class="form-group">
                <label for="create_user_name">Jméno uživatele</label>
                <input type="text" id="create_user_name" name="user_name" required>
            </div>
            <div class="form-group">
                <label for="create_email">E-mail</label>
                <input type="email" id="create_email" name="email" required>
            </div>
            <div class="form-group">
                <label for="create_tier_id">Tarif</label>
                <select id="create_tier_id" name="tier_id">
                    {% for t in product_tiers or tiers_list %}
                    <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                    {% if not (product_tiers or tiers_list) %}
                    <option value="1">Free</option><option value="2">Basic</option><option value="3">Pro</option><option value="4">Trial</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label for="create_password">Heslo (pro přihlášení e-mailem v agentovi)</label>
                <input type="password" id="create_password" name="password" placeholder="Doporučeno vyplnit">
            </div>
            <div class="form-group">
                <label for="create_days">Platnost (dní, prázdné = neomezeno)</label>
                <input type="number" id="create_days" name="days" value="365" min="1">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createModal')">Zrušit</button>
                <button type="submit" class="btn btn-primary">Vytvořit</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal" style="max-width:520px;">
        <div class="modal-header">
            <h3>Upravit uživatele</h3>
            <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
        </div>
        <form id="editForm" onsubmit="submitEditForm(event)">
            <input type="hidden" id="edit_api_key" name="api_key">
            <div class="form-group">
                <label for="edit_user_name">Jméno</label>
                <input type="text" id="edit_user_name" name="user_name" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_email">E-mail</label>
                <input type="email" id="edit_email" name="email" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_tier_id">Tarif</label>
                <select id="edit_tier_id" name="tier_id">
                    {% for t in product_tiers or tiers_list %}
                    <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                    {% if not (product_tiers or tiers_list) %}
                    <option value="1">Free</option><option value="2">Basic</option><option value="3">Pro</option><option value="4">Trial</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label for="edit_license_expires">Datum expirace</label>
                <input type="date" id="edit_license_expires" name="license_expires" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_is_active">Status</label>
                <select id="edit_is_active" name="is_active" class="form-control">
                    <option value="1">Aktivní</option>
                    <option value="0">Blokovaný</option>
                </select>
            </div>
            <div class="form-group">
                <label>Stávající heslo</label>
                <div id="edit_current_password_display" style="font-family:monospace;padding:8px;background:#f3f4f6;border-radius:6px;font-size:0.95em;margin-bottom:4px;">—</div>
            </div>
            <div class="form-group">
                <label for="edit_new_password">Nové heslo (nevyplňovat = beze změny)</label>
                <input type="text" id="edit_new_password" name="new_password" class="form-control" placeholder="Min. 6 znaků" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="edit_payment_method">Způsob platby</label>
                <select id="edit_payment_method" name="payment_method" class="form-control">
                    <option value="">—</option>
                    <option value="Karta">Karta</option>
                    <option value="Převod">Převod</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_last_payment_date">Datum poslední platby</label>
                <input type="date" id="edit_last_payment_date" name="last_payment_date" class="form-control">
            </div>
            <div class="form-group">
                <label>Historie fakturace</label>
                <div id="editBillingList" style="max-height:120px;overflow-y:auto;font-size:0.8em;color:#6b7280;margin-top:4px;"></div>
                <button type="button" class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="openAddBillingModal()">+ Přidat záznam</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Zrušit</button>
                <button type="submit" class="btn btn-primary">Uložit</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="changePasswordModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Změnit heslo uživatele</h3>
            <button class="modal-close" onclick="closeModal('changePasswordModal')">&times;</button>
        </div>
        <p style="margin-bottom:16px;color:#6b7280;">Uživatel: <strong id="changePasswordUserDisplay"></strong></p>
        <div class="form-group" style="margin-bottom:16px;">
            <label>Stávající heslo</label>
            <div id="changePasswordCurrentDisplay" style="font-family:monospace;padding:8px;background:#f3f4f6;border-radius:6px;font-size:0.95em;">—</div>
        </div>
        <form id="changePasswordForm" onsubmit="submitChangePassword(event)">
            <input type="hidden" id="changePasswordApiKey" name="api_key">
            <div class="form-group">
                <label for="changePasswordNew">Nové heslo</label>
                <input type="text" id="changePasswordNew" name="new_password" required minlength="6" placeholder="Min. 6 znaků" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="changePasswordNew2">Nové heslo znovu</label>
                <input type="text" id="changePasswordNew2" name="new_password2" required minlength="6" autocomplete="off">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Zrušit</button>
                <button type="submit" class="btn btn-primary">Uložit heslo</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="welcomePackageModal">
    <div class="modal" style="max-width:560px;">
        <div class="modal-header">
            <h3>Údaje licence</h3>
            <button class="modal-close" onclick="closeModal('welcomePackageModal')">&times;</button>
        </div>
        <p style="margin-bottom:12px;color:#6b7280;font-size:0.9em;">Pouze zobrazení údajů licence. Heslo se negeneruje ani nemění.</p>
        <div id="welcomePackageContent" style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;font-family:monospace;font-size:0.85em;white-space:pre-wrap;word-break:break-all;max-height:280px;overflow-y:auto;"></div>
        <div class="modal-actions" style="margin-top:16px;">
            <button type="button" class="btn btn-secondary" onclick="closeModal('welcomePackageModal')">Zavřít</button>
            <button type="button" class="btn btn-primary" id="welcomePackageCopyBtn" style="display:none;" onclick="copyWelcomePackageText()">Kopírovat text</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="resultModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Výsledek</h3>
            <button class="modal-close" onclick="closeModal('resultModal')">&times;</button>
        </div>
        <div id="resultContent"></div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="closeModal('resultModal'); location.reload();">OK</button>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
var _activity30 = {{ (activity_30 or []) | tojson }};
var _byTierCounts = {{ (by_tier_counts or {}) | tojson }};
var _kpis = {{ (kpis or {}) | tojson }};
</script>
<script>
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function openCreateModal() { document.getElementById('createForm').reset(); openModal('createModal'); }
function openEditModalFromRow(tr) {
    var apiKey = tr.getAttribute('data-api-key');
    var tierId = tr.getAttribute('data-tier-id') || '';
    var pwdPlain = tr.getAttribute('data-password-plain') || '';
    document.getElementById('edit_api_key').value = apiKey;
    document.getElementById('edit_user_name').value = tr.getAttribute('data-user-name') || '';
    document.getElementById('edit_email').value = tr.getAttribute('data-email') || '';
    document.getElementById('edit_license_expires').value = (tr.getAttribute('data-license-expires') || '').substring(0, 10);
    document.getElementById('edit_is_active').value = tr.getAttribute('data-is-active') === '1' ? '1' : '0';
    document.getElementById('edit_payment_method').value = tr.getAttribute('data-payment-method') || '';
    document.getElementById('edit_last_payment_date').value = (tr.getAttribute('data-last-payment-date') || '').substring(0, 10);
    document.getElementById('edit_current_password_display').textContent = pwdPlain || '—';
    document.getElementById('edit_new_password').value = '';
    var sel = document.getElementById('edit_tier_id');
    if (tierId && tierId !== 'None') sel.value = tierId;
    else if (sel.options.length) sel.selectedIndex = 0;
    loadBillingHistory(apiKey);
    openModal('editModal');
}
async function loadBillingHistory(apiKey) {
    var el = document.getElementById('editBillingList');
    el.innerHTML = 'Načítám…';
    try {
        var r = await fetch('/admin/api/license/billing?api_key=' + encodeURIComponent(apiKey));
        var data = await r.json();
        if (data.success && data.data && data.data.length) {
            el.innerHTML = data.data.map(function(x) {
                return '<div style="padding:4px 0;border-bottom:1px solid #eee;">' + (x.description || '-') + ' ' + (x.amount_cents != null ? x.amount_cents + ' Kč' : '') + ' <small>' + (x.paid_at || x.created_at || '').substring(0, 10) + '</small></div>';
            }).join('');
        } else { el.innerHTML = '<span class="text-muted">Žádné záznamy</span>'; }
    } catch (e) { el.innerHTML = '<span style="color:#dc2626;">Chyba načtení</span>'; }
}
function openAddBillingModal() {
    var apiKey = document.getElementById('edit_api_key').value;
    var desc = prompt('Popis (např. Faktura 2025-01):');
    if (desc === null) return;
    var amount = prompt('Částka (Kč):', '0');
    if (amount === null) return;
    var paidAt = prompt('Datum platby (YYYY-MM-DD):', new Date().toISOString().substring(0, 10));
    if (paidAt === null) return;
    var fd = new FormData();
    fd.append('api_key', apiKey);
    fd.append('description', desc);
    fd.append('amount_cents', Math.round(parseFloat(amount) || 0) * 100);
    fd.append('paid_at', paidAt);
    fetch('/admin/api/license/billing', { method: 'POST', body: fd }).then(function(r) { return r.json(); }).then(function(res) {
        if (res.success) { loadBillingHistory(apiKey); alert('Záznam přidán'); }
        else alert(res.error || 'Chyba');
    }).catch(function(e) { alert('Chyba: ' + e.message); });
}
var lastWelcomePackageText = '';
function openWelcomePackageModal(btn) {
    var apiKey = btn.getAttribute('data-api-key');
    document.getElementById('welcomePackageContent').textContent = 'Načítám…';
    document.getElementById('welcomePackageCopyBtn').style.display = 'none';
    openModal('welcomePackageModal');
    var fd = new FormData();
    fd.append('api_key', apiKey);
    fetch('/admin/api/license/welcome-package', { method: 'POST', body: fd })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            lastWelcomePackageText = data.email_body || '';
            document.getElementById('welcomePackageContent').textContent = lastWelcomePackageText || (data.error || 'Chyba');
            document.getElementById('welcomePackageCopyBtn').style.display = lastWelcomePackageText ? 'inline-block' : 'none';
        })
        .catch(function(e) { document.getElementById('welcomePackageContent').textContent = 'Chyba: ' + e.message; });
}
function copyWelcomePackageText() {
    if (lastWelcomePackageText && navigator.clipboard) {
        navigator.clipboard.writeText(lastWelcomePackageText).then(function() { alert('Text zkopírován do schránky.'); });
    }
}
function openChangePasswordModal(btn) {
    var apiKey = btn.getAttribute('data-api-key');
    var display = btn.getAttribute('data-user-display') || apiKey;
    var pwdPlain = btn.getAttribute('data-password-plain') || '';
    document.getElementById('changePasswordApiKey').value = apiKey;
    document.getElementById('changePasswordUserDisplay').textContent = display;
    document.getElementById('changePasswordCurrentDisplay').textContent = pwdPlain || '—';
    document.getElementById('changePasswordForm').reset();
    openModal('changePasswordModal');
}
async function submitChangePassword(e) {
    e.preventDefault();
    var apiKey = document.getElementById('changePasswordApiKey').value;
    var newPass = document.getElementById('changePasswordNew').value;
    var newPass2 = document.getElementById('changePasswordNew2').value;
    if (newPass !== newPass2) { showResult('Hesla se neshodují', true); return; }
    if (newPass.length < 6) { showResult('Heslo musí mít alespoň 6 znaků', true); return; }
    var data = new FormData();
    data.append('api_key', apiKey);
    data.append('new_password', newPass);
    data.append('new_password2', newPass2);
    try {
        var resp = await fetch('/admin/api/license/set-password', { method: 'POST', body: data });
        var result = await resp.json();
        closeModal('changePasswordModal');
        showResult(result.message || result.error, !result.success);
    } catch (err) { showResult('Chyba: ' + err.message, true); }
}
function showResult(message, isError) {
    var content = document.getElementById('resultContent');
    content.innerHTML = '<div class="alert alert-' + (isError ? 'error' : 'success') + '">' + message + '</div>';
    openModal('resultModal');
}
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() { alert('API klíč zkopírován do schránky'); });
}
async function doGitPull() {
    var btn = document.getElementById('btn-git-pull');
    if (btn.disabled) return;
    btn.disabled = true;
    btn.textContent = '... probíhá ...';
    try {
        var resp = await fetch('{{ url_for("admin.api_git_pull") }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        var text = await resp.text();
        var data;
        try {
            data = (text && text.trim().startsWith('{')) ? JSON.parse(text) : { success: false, log: ['Odpověď není JSON (server mohl vrátit 502/500).'] };
        } catch (parseErr) {
            data = { success: false, log: ['Server vrátil stránku místo JSON. Na PA spusťte git pull v Bash a Reload.'] };
        }
        var log = (data.log || []).join('\n');
        alert(data.success ? 'Hotovo.\n\n' + log : 'Chyba:\n\n' + log);
    } catch (e) { alert('Chyba: ' + e.message); }
    btn.disabled = false;
    btn.innerHTML = '&#128260; Git Pull';
}
async function submitCreateForm(e) {
    e.preventDefault();
    var data = new FormData(document.getElementById('createForm'));
    data.append('tier_id', document.getElementById('create_tier_id').value);
    try {
        var response = await fetch('/admin/api/license/create', { method: 'POST', body: data });
        var result = await response.json();
        if (result.success) {
            closeModal('createModal');
            showResult('<p><strong>Licence vytvořena!</strong></p><p style="margin-top:12px;">API klíč:</p><div style="background:#f3f4f6;padding:12px;border-radius:8px;font-family:monospace;word-break:break-all;margin-top:8px;">' + result.api_key + '</div><button class="btn btn-secondary btn-small" style="margin-top:12px;" onclick="copyToClipboard(\'' + result.api_key + '\')">Kopírovat</button>', false);
        } else { showResult(result.error || 'Chyba při vytváření', true); }
    } catch (err) { showResult('Chyba: ' + err.message, true); }
}
async function submitEditForm(e) {
    e.preventDefault();
    var data = new FormData(document.getElementById('editForm'));
    var np = document.getElementById('edit_new_password').value;
    if (np) data.set('new_password', np);
    try {
        var response = await fetch('{{ url_for("admin.api_update_license") }}', { method: 'POST', body: data });
        var result = await response.json();
        closeModal('editModal');
        showResult(result.message || result.error, !result.success);
        if (result.success) setTimeout(function() { location.reload(); }, 800);
    } catch (err) { showResult('Chyba: ' + err.message, true); }
}
async function toggleLicense(apiKey, activate) {
    if (!confirm('Opravdu chcete ' + (activate ? 'aktivovat' : 'deaktivovat') + ' tuto licenci?')) return;
    var data = new FormData();
    data.append('api_key', apiKey);
    data.append('is_active', activate ? '1' : '0');
    try {
        var response = await fetch('/admin/api/license/toggle', { method: 'POST', body: data });
        var result = await response.json();
        showResult(result.message || result.error, !result.success);
    } catch (err) { showResult('Chyba: ' + err.message, true); }
}
async function deleteLicense(apiKey) {
    if (!confirm('Opravdu chcete SMAZAT tuto licenci? Tato akce je nevratná!')) return;
    if (!confirm('Potvrzujete smazání licence?')) return;
    var data = new FormData();
    data.append('api_key', apiKey);
    try {
        var response = await fetch('/admin/api/license/delete', { method: 'POST', body: data });
        var result = await response.json();
        showResult(result.message || result.error, !result.success);
    } catch (err) { showResult('Chyba: ' + err.message, true); }
}
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(function(modal) { modal.classList.remove('active'); });
    }
});

// Grafy (Chart.js)
(function initCharts() {
    if (typeof Chart === 'undefined') return;
    var colors = { blue: 'rgb(52, 152, 219)', green: 'rgb(46, 204, 113)', red: 'rgb(231, 76, 60)', orange: 'rgb(230, 126, 34)', gray: 'rgb(149, 165, 166)', purple: 'rgb(155, 89, 182)' };
    var tierColors = [colors.blue, colors.green, colors.orange, colors.purple, colors.gray];

    var ctxActivity = document.getElementById('chartActivity30');
    if (ctxActivity && _activity30 && _activity30.length) {
        new Chart(ctxActivity, {
            type: 'bar',
            data: {
                labels: _activity30.map(function(x) { return (x.date || '').toString().substring(5); }),
                datasets: [{ label: 'Soubory', data: _activity30.map(function(x) { return x.files || 0; }), backgroundColor: colors.blue }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }

    var ctxPie = document.getElementById('chartTiersPie');
    if (ctxPie && _byTierCounts && typeof _byTierCounts === 'object') {
        var tierLabels = Object.keys(_byTierCounts);
        var tierData = tierLabels.map(function(k) { return _byTierCounts[k] || 0; });
        if (tierData.some(function(v) { return v > 0; })) {
            new Chart(ctxPie, {
                type: 'pie',
                data: { labels: tierLabels, datasets: [{ data: tierData, backgroundColor: tierColors.slice(0, tierLabels.length) }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    }

    var ctxChecks = document.getElementById('chartChecksBar');
    if (ctxChecks && _kpis) {
        var ok = _kpis.success_checks || 0, err = _kpis.error_checks || 0;
        new Chart(ctxChecks, {
            type: 'bar',
            data: {
                labels: ['Úspěšné', 'Chybné'],
                datasets: [{ label: 'Počet', data: [ok, err], backgroundColor: [colors.green, colors.red] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
})();
</script>
{% endblock %}
